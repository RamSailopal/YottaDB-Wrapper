#!/bin/bash
docs() {
	if [[ "$1" == "" ]]
	then
		echo "Please enter the keyword to search the documentation for"
		exit
	fi
 	srch=$(/opt/yottadb/current/ydb <<< "D SEARCH^HELPPROC(\"$resp\")" |  awk '!/^YDB>/&&!/^$/ { print }')
        srchcnt=$(/opt/yottadb/current/ydb <<< "D SEARCH^HELPPROC(\"$resp\")" |  awk '!/^YDB>/&&!/^$/ { print }' | wc -l)
        resp1="1"
        while [[ $resp1 != "" ]]
        do
              resp1=$(dialog --menu "Select a topic:" 10 100 $srchcnt $srch  2>&1 >/dev/tty)
              srchsel=$(awk -v resp=$resp1 '$1==resp { sub("%","_",$2);print $2 }' <<< "$srch")
              srchsel1=$(awk -F "->" '{ print $1 }' <<< "$srchsel")
              srchsel2=$(awk -F "->" '{ print $2 }' <<< "$srchsel")
              srchsel3=$(awk -F "->" '{ print $3 }' <<< "$srchsel")
              srchsel4=$(awk -F "->" '{ print $4 }' <<< "$srchsel")
              srchsel5=$(awk -F "->" '{ print $5 }' <<< "$srchsel")
              if [[ "$srchsel2" == "" ]]
              then
                   info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$srchsel1\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
              elif [[ "$srchsel3" == "" ]]
              then
                   info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$srchsel1\",\"s\",\"$srchsel2\",\"\",\"\",\"\",\"\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
              elif [[ "$srchsel4" == "" ]]
              then
                   info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$srchsel1\",\"s\",\"$srchsel2\",\"s\",\"$srchsel3\",\"\",\"\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
              elif [[ "$srchsel5" == "" ]]
              then
                   info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$srchsel1\",\"s\",\"$srchsel2\",\"s\",\"$srchsel3\",\"s\",\"$srchsel4\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
              else
                   info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$srchsel1\",\"s\",\"$srchsel2\",\"s\",\"$srchsel3\",\"s\",\"$srchsel4\",\"s\",\"$srchsel5\")" |  awk '!/^YDB>/ { print }')
              fi
              if [[ "$info" != "" ]]
              then
                   dialog --exit-label Continue --msgbox "$info" 50 100
              fi
        done

}
help() {
        echo -e "Alias help\n"
	echo "ydb-help - List of YottaDB aliases"
	echo "ydb-start - YottaDB interactive command line"
	echo "ydb-search - Search YottaDB documentation"
	echo "ydb-edit - Edit YottaDB routines"
        echo "ydb-rlist - List YottaDB routines"
        echo "ydb-glist - List YottaDB globals"
	echo "ydb-gview - View YottaDB global"
	exit
}
setup() {
        grep -q "alias ydb-help" ~/.bashrc || echo 'alias ydb-help="ydb -a"' >>  ~/.bashrc
        grep -q "alias ydb-start" ~/.bashrc || echo 'alias ydb-start="ydb"' >>  ~/.bashrc
        grep -q "alias ydb-edit" ~/.bashrc || echo 'alias ydb-edit="ydb -e"' >>  ~/.bashrc
        grep -q "alias ydb-rlist" ~/.bashrc || echo 'alias ydb-rlist="ydb -l"' >>  ~/.bashrc
        grep -q "alias ydb-glist" ~/.bashrc || echo 'alias ydb-glist="ydb -g"' >>  ~/.bashrc
        grep -q "alias ydb-gview" ~/.bashrc || echo 'alias ydb-gview="ydb -v"' >>  ~/.bashrc
        grep -q "alias ydb-search" ~/.bashrc || echo 'alias ydb-search="ydb -d"' >>  ~/.bashrc
	echo -e "Alias' have been set up\n\n"
	echo -e "\n\nPlease reload your shell for the changes to take effect\n\n"
        help
	exit
}
glblist() {
            echo -e "GLobal List\n"
	    export ydb_gbldir="/data/r1.34_x86_64/g/yottadb.gld"
	    glbs="$((echo "D ^%GD";echo "*";echo "H") | /opt/yottadb/current/ydb | awk '/^\^/ { for(i=1;i<=NF;i++) { cnt++;print cnt" "$i } } ')"
            echo "$glbs"
            exit
}
routlist() {
 	   export ydb_gbldir="/data/r1.34_x86_64/g/yottadb.gld"
	   source /opt/yottadb/current/ydb_env_set
           echo -e "Routine List\n"
	   routs=$((echo "D ^%RD";echo "*";echo "";echo "H") | /opt/yottadb/current/ydb | awk 'BEGIN { cnt=0 } !/^Routine/&&!/^YDB>/&&!/^$/&&!/^Total of/ { for (i=1;i<=NF;i++) { cnt++;print cnt" "$i } }')
	   echo "$routs"
	   exit
}
glbview() {

	   if [[ "$1" == "" ]]
           then
                echo "Please pass a global name as a parameter i.e. myglobal"
                exit
           fi
           export ydb_gbldir="/data/r1.34_x86_64/g/yottadb.gld"
           source /opt/yottadb/current/ydb_env_set
           glbal="$1"
	   (echo "D ^%G";echo "";echo "$glbal";) | /opt/yottadb/current/ydb
           exit
}
routedit() {
           if [[ "$1" == "" ]]
	   then
		echo "Please pass a routine name as a parameter i.e. myroutine"
		exit
	   fi
           export ydb_gbldir="/data/r1.34_x86_64/g/yottadb.gld"
           source /opt/yottadb/current/ydb_env_set
           routine="$1"
	   find $(sed -n 's/[)]//;s/[(]//;s/[*]/ /p;' <<< $ydb_routines) -name "$routine.m" -exec vi '{}' \;
	   /opt/yottadb/current/ydb <<< "ZL \"$routine.m\""
           exit
}
mens() {
	if [[ "$1" != "1" ]]
	then
		dialog --exit-label Continue --textbox /opt/yottadb/current/splash.txt 20 100
		clear
	fi
	resp=$(dialog --menu "Select an option:" 10 100 6 1 "Access YottaDB" 2 "View a global" 3 "Edit routine" 4 "Offline Documentation" 5 "Search documentation" 6 "Exit" 2>&1 >/dev/tty)
	if [[ "$resp" == "" ]]
	then
	    exit
	fi
	if [[ "$resp" == "1" ]]
	then
        export ydb_gbldir="/data/r1.34_x86_64/g/yottadb.gld"
	    clear
	    echo -e "**************************************************************************************************************************\n"
	    echo -e "Welcome to YottaDB!\n"
	    echo -e 'To exit enter "H"\n'
	    echo -e "For more information on YottaDB, refer to the YottaDB website either from a browser or from another terminal window\n"
	    echo -e "**************************************************************************************************************************\n"
	    /opt/yottadb/current/ydb
		mens 1
	fi
	if [[ "$resp" == "2" ]]
	then
        export ydb_gbldir="/data/r1.34_x86_64/g/yottadb.gld"
	    glbcnt="$((echo "D ^%GD";echo "*";echo "H") | /opt/yottadb/current/ydb | awk '/^\^/ { for(i=1;i<=NF;i++) { cnt++ } } END { print cnt }')"
	    glbs="$((echo "D ^%GD";echo "*";echo "H") | /opt/yottadb/current/ydb | awk '/^\^/ { for(i=1;i<=NF;i++) { cnt++;print cnt" "$i } } ')"
	    if [[ "$glbs" == "" ]]
	    then
	        dialog --infobox "No Globals" 10 50
			sleep 3
	        mens 1
	    fi
	    resp1=$(dialog --menu "Select Global:" 10 100 $glbcnt $glbs  2>&1 >/dev/tty)
	    glbal=$(awk -v resp=$resp1 '$1==resp { print $2 }' <<< "$glbs")
	    clear
	    (echo "D ^%G";echo "";echo "$glbal";) | /opt/yottadb/current/ydb
	    echo ""
	    read -p "Press Enter to continue" resp
	    mens 1
	fi
	if [[ "$resp" == "3" ]]
	then
       export ydb_gbldir="/data/r1.34_x86_64/g/yottadb.gld"
	   source /opt/yottadb/current/ydb_env_set
	   routcnt=$((echo "D ^%RD";echo "*";echo "";echo "H") | /opt/yottadb/current/ydb | awk '!/^Routine/&&!/^YDB>/&&!/^$/&&!/^Total of/ { for (i=1;i<=NF;i++) { cnt++ } } END { print cnt+1 }')
	   routs=$((echo "D ^%RD";echo "*";echo "";echo "H") | /opt/yottadb/current/ydb | awk 'BEGIN { cnt=1 } !/^Routine/&&!/^YDB>/&&!/^$/&&!/^Total of/ { for (i=1;i<=NF;i++) { cnt++;print cnt" "$i } }')
	   routs=$(echo "1 New_Routine";echo "$routs")
	   if [[ "$routs" == "" ]]
	   then
	        dialog --infobox "No routines" 10 50
	        mens 1
	   fi
	   resp1=$(dialog --menu "Select Routine:" 10 100 $routcnt $routs  2>&1 >/dev/tty)
	   echo $resp1
	   if [[ "$resp1" == "1" ]]
	   then
	        resp2=$(dialog --inputbox "Enter a routine name i.e TESTROUTINE (no .m not spaces):" 50 100 2>&1 >/dev/tty)
			if [[ "$resp2" != "" ]]
			then
				vi "/data/r1.34_x86_64/r/$resp2.m"
				clear
            	/opt/yottadb/current/ydb <<< "ZL \"$resp2.m\""
				read -p "Press Enter to continue" resp
	   			mens 1
			else
				mens 1
			fi
	   else
	   		routine=$(awk -v resp=$resp1 '$1==resp { sub("%","_",$2);print $2 }' <<< "$routs")
	   		find $(sed -n 's/[)]//;s/[(]//;s/[*]/ /p;' <<< $ydb_routines) -name "$routine.m" -exec vi '{}' \;
	   		clear
       		/opt/yottadb/current/ydb <<< "ZL \"$routine.m\""
	   		read -p "Press Enter to continue" resp
	   		mens 1
	   fi
	fi
	if [[ "$resp" == "4" ]]
	then
	   export ydb_gbldir="/opt/yottadb/current/gtmhelp.gld"
	   menu=$(/opt/yottadb/current/ydb <<< 'D PROCENTRY^HELPPROC' |  awk '!/^YDB>/&&!/^$/ { print }')
	   menucnt=$(/opt/yottadb/current/ydb <<< 'D PROCENTRY^HELPPROC' |  awk '!/^YDB>/&&!/^$/ { print }' | wc -l)
           if [[ "$menu" == "" ]]
           then
                mens 1
           fi

	   resp1=$(dialog --menu "Select a topic:" 10 100 $menucnt $menu  2>&1 >/dev/tty)
	   if [[ "$resp1" == "" ]]
	   then
	       mens 1
	   fi
	   helpsel=$(awk -v resp=$resp1 '$1==resp { sub("%","_",$2);print $2 }' <<< "$menu")
	   info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$helpsel\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
	   if [[ "$info" == "" ]]
	   then
	        mens 1
	   fi
	   dialog --exit-label Continue --msgbox "$info" 50 100
	   menu1=$(/opt/yottadb/current/ydb <<< "D PROCMENU^HELPPROC(\"$helpsel\",\"\",\"\",\"\")" |  awk '!/^YDB>/&&!/^$/ { print }')
	   menucnt1=$(/opt/yottadb/current/ydb <<< "D PROCMENU^HELPPROC(\"$helpsel\",\"\",\"\",\"\")" |  awk '!/^YDB>/&&!/^$/ { print }' | wc -l)
           if [[ "$menu1" == "" ]]
           then
                mens 1
           fi

	   resp2=$(dialog --menu "Select a topic:" 10 100 $menucnt1 $menu1  2>&1 >/dev/tty)
	   if [[ "$resp2" == "" ]]
	   then
	       mens 1
	   fi
	   helpsel1=$(awk -v resp=$resp2 '$1==resp { sub("%","_",$2);print $2 }' <<< "$menu1")
	   info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$helpsel\",\"s\",\"$helpsel1\",\"\",\"\",\"\",\"\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
	   if [[ "$info" == "" ]]
	   then
	        mens 1
	   fi
	   dialog --exit-label Continue --msgbox "$info" 50 100
	   menu2=$(/opt/yottadb/current/ydb <<< "D PROCMENU^HELPPROC(\"$helpsel\",\"$helpsel1\",\"\",\"\")" |  awk '!/^YDB>/&&!/^$/ { print }')
	   menucnt2=$(/opt/yottadb/current/ydb <<< "D PROCMENU^HELPPROC(\"$helpsel\",\"$helpsel1\",\"\",\"\")" |  awk '!/^YDB>/&&!/^$/ { print }' | wc -l)
           if [[ "$menu2" == "" ]]
           then
                mens 1
           fi

	   resp3=$(dialog --menu "Select a topic:" 10 100 $menucnt2 $menu2  2>&1 >/dev/tty)
	   if [[ "$resp3" == "" ]]
	   then
	       mens 1
	   fi
	   helpsel2=$(awk -v resp=$resp3 '$1==resp { sub("%","_",$2);print $2 }' <<< "$menu2")
	   info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$helpsel\",\"s\",\"$helpsel1\",\"s\",\"$helpsel2\",\"\",\"\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
	   if [[ "$info" == "" ]]
	   then
	        mens 1
	   fi
	   dialog --exit-label Continue --msgbox "$info" 50 100
	   menu3=$(/opt/yottadb/current/ydb <<< "D PROCMENU^HELPPROC(\"$helpsel\",\"$helpsel1\",\"$helpsel2\",\"\")" |  awk '!/^YDB>/&&!/^$/ { print }')
	   menucnt3=$(/opt/yottadb/current/ydb <<< "D PROCMENU^HELPPROC(\"$helpsel\",\"$helpsel1\",\"$helpsel2\",\"\")" |  awk '!/^YDB>/&&!/^$/ { print }' | wc -l)
           if [[ "$menu3" == "" ]]
           then
                mens 1
           fi

	   resp4=$(dialog --menu "Select a topic:" 10 100 $menucnt3 $menu3  2>&1 >/dev/tty)
	   if [[ "$resp4" == "" ]]
	   then
	       mens 1
	   fi
	   helpsel3=$(awk -v resp=$resp4 '$1==resp { sub("%","_",$2);print $2 }' <<< "$menu3")
	   info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$helpsel\",\"s\",\"$helpsel1\",\"s\",\"$helpsel2\",\"s\",\"$helpsel3\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
	   if [[ "$info" == "" ]]
	   then
        	mens 1
	   fi
	   dialog --exit-label Continue --msgbox "$info" 50 100
	   menu4=$(/opt/yottadb/current/ydb <<< "D PROCMENU^HELPPROC(\"$helpsel\",\"$helpsel1\",\"$helpsel2\",\"$helpsel3\")" |  awk '!/^YDB>/&&!/^$/ { print }')
	   menucnt4=$(/opt/yottadb/current/ydb <<< "D PROCMENU^HELPPROC(\"$helpsel\",\"$helpsel1\",\"$helpsel2\",\"$helpsel3\")" |  awk '!/^YDB>/&&!/^$/ { print }' | wc -l)
           if [[ "$menu4" == "" ]]
           then
				mens 1
           fi
	   resp5=$(dialog --menu "Select a topic:" 10 100 $menucnt4 $menu4  2>&1 >/dev/tty)
	   if [[ "$resp5" == "" ]]
	   then
	       mens 1
	   fi
	   helpsel4=$(awk -v resp=$resp5 '$1==resp { sub("%","_",$2);print $2 }' <<< "$menu4")
	   info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$helpsel\",\"s\",\"$helpsel1\",\"s\",\"$helpsel2\",\"s\",\"$helpsel3\",\"s\",\"$helpsel4\")" |  awk '!/^YDB>/ { print }')
	   if [[ "$info" == "" ]]
	   then
	        mens 1
	   fi
	   dialog --exit-label Continue --msgbox "$info" 50 100

	fi
        if [[ "$resp" == "5" ]]
        then
 		resp=$(dialog --inputbox "Enter search item" 50 100 2>&1 >/dev/tty)	
                dialog --infobox "Searching..." 50 100
                srch=$(/opt/yottadb/current/ydb <<< "D SEARCH^HELPPROC(\"$resp\")" |  awk '!/^YDB>/&&!/^$/ { print }')
                srchcnt=$(/opt/yottadb/current/ydb <<< "D SEARCH^HELPPROC(\"$resp\")" |  awk '!/^YDB>/&&!/^$/ { print }' | wc -l)
                resp1="1"
                while [[ $resp1 != "" ]]
                do
	                resp1=$(dialog --menu "Select a topic:" 10 100 $srchcnt $srch  2>&1 >/dev/tty)
	                srchsel=$(awk -v resp=$resp1 '$1==resp { sub("%","_",$2);print $2 }' <<< "$srch")
	                srchsel1=$(awk -F "->" '{ print $1 }' <<< "$srchsel")
			srchsel2=$(awk -F "->" '{ print $2 }' <<< "$srchsel")
			srchsel3=$(awk -F "->" '{ print $3 }' <<< "$srchsel")
			srchsel4=$(awk -F "->" '{ print $4 }' <<< "$srchsel")
	                srchsel5=$(awk -F "->" '{ print $5 }' <<< "$srchsel")
	      	        if [[ "$srchsel2" == "" ]]
      	                then
		  		info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$srchsel1\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
                	elif [[ "$srchsel3" == "" ]]
                	then
                  		info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$srchsel1\",\"s\",\"$srchsel2\",\"\",\"\",\"\",\"\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
                	elif [[ "$srchsel4" == "" ]]
                	then
                  		info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$srchsel1\",\"s\",\"$srchsel2\",\"s\",\"$srchsel3\",\"\",\"\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
                	elif [[ "$srchsel5" == "" ]]
                	then
                  		info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$srchsel1\",\"s\",\"$srchsel2\",\"s\",\"$srchsel3\",\"s\",\"$srchsel4\",\"\",\"\")" |  awk '!/^YDB>/ { print }')
                	else
                  		info=$(/opt/yottadb/current/ydb <<< "D PROCINFO^HELPPROC(\"$srchsel1\",\"s\",\"$srchsel2\",\"s\",\"$srchsel3\",\"s\",\"$srchsel4\",\"s\",\"$srchsel5\")" |  awk '!/^YDB>/ { print }')
                	fi
                        if [[ "$info" != "" ]]
		        then
           			dialog --exit-label Continue --msgbox "$info" 50 100
			fi
 		done
                mens 1

                
        fi
	if [[ "$resp" == "6" ]]
	then
		exit
	fi
}
while getopts "n h l e a g v s d " o; do
    case "${o}" in
        n)
		    source /opt/yottadb/current/ydb_env_set
		    export ydb_gbldir="/data/r1.34_x86_64/g/yottadb.gld"
			clear
            /opt/yottadb/current/ydb
            exit
            ;;
        h)
            echo -e "\nEnter -n to bypass the YottaDB banner\n"
            exit
            ;;
        l)  
            routlist
            exit
            ;;
        e)
            routedit "$2"
            ;;
        a)
            help
            ;;
        g)
	    glblist
            ;;
        v)
            glbview "$2"
            ;;
        s)
            setup
            ;;
        d)
            docs "$2"
            ;;
        *)
            mens
            ;;
    esac
done
mens
